jQuery.sap.declare("com.ril.IntMovMatPos.Component");
jQuery.sap.require("sap.ui.core.UIComponent");
jQuery.sap.require("sap.ui.core.routing.History");
jQuery.sap.require("sap.m.routing.RouteMatchedHandler");
jQuery.sap.require("com.ril.IntMovMatPos.util.Formatter");
jQuery.sap.require("sap.m.MessageBox");

//var ga;
//Global flag for GST
//var GSTStatus = false;

sap.ui.core.UIComponent.extend("com.ril.IntMovMatPos.Component", {
	metadata: {
		"name": "IntMovMatPos",
		"version": "1.1.0-SNAPSHOT",
		"includes": ["util/Formatter.js", "../../../../../../sap/bc/ui5_ui5/sap/ZUSAGE/USAGE_CORE.js"],
		/**/
		//"includes": ["util/Formatter.js"],
		"dependencies": {
			"libs": ["sap.m", "sap.ui.layout"],
			"components": []
		},
		"config": {
			resourceBundle: "i18n/messageBundle.properties",
			serviceConfig: {
				name: "",
				    serviceUrl: com.ril.IntMovMatPos.util.Formatter.getServiceUrl() 
				//serviceUrl: "/sap/opu/odata/sap/Z_FIORI_LOG_SW_MATERIAL_DG_SRV"
			}
		},
		routing: {
			config: {
				"viewType": "XML",
				"viewPath": "com.ril.IntMovMatPos.view",
				"targetControl": "fioriContent",
				"targetAggregation": "pages",
				"clearTarget": false
			},
			routes: [{
				pattern: "",
				name: "S1",
				view: "S1"
			}]
		}
	},
	createContent: function() {
		var oViewData = {
			component: this
		};

		return sap.ui.view({
			viewName: "com.ril.IntMovMatPos.view.Main",
			type: sap.ui.core.mvc.ViewType.XML,
			viewData: oViewData
		});
	},

	init: function() {
		ga = new ZUSAGE.USAGE_CORE().USAGE_LOG;
		sap.ui.core.UIComponent.prototype.init.apply(this, arguments);
		var oServiceConfig = this.getMetadata().getConfig().serviceConfig;
		var sServiceUrl = oServiceConfig.serviceUrl;
		this._routeMatchedHandler = new sap.m.routing.RouteMatchedHandler(this.getRouter(), this._bRouterCloseDialogs);
		this._initODataModel(sServiceUrl);
		
		var sRootPath = jQuery.sap.getModulePath("com.ril.IntMovMatPos");
		
		// the metadata is read to get the location of the i18n language files later
		var mConfig = this.getMetadata().getConfig();
		
	// set i18n model
		var i18nModel = new sap.ui.model.resource.ResourceModel({
			bundleUrl: [sRootPath, mConfig.resourceBundle].join("/")
		});
		this.setModel(i18nModel, "i18n");

		//GST Code Changes
		var gModel = new sap.ui.model.odata.ODataModel("/sap/opu/odata/sap/Z_FIORI_GST_ACTIVE_SRV;mo/", {
			json: true,
			loadMetadataAsync: true
		});
		
		gModel.setDefaultBindingMode(sap.ui.model.BindingMode.OneWay);

		var compThat = this;
		gModel.read("/GSTActiveFlagSet(SAP__Origin='GWEWM_LCL',Server='')", {
			"async": false,
			success: function(OData, oResponse) {
				//data = OData;
					var jModel = new sap.ui.model.json.JSONModel(OData);
					compThat.setModel(jModel, "GSTModel");
				
			}
		/*	error: function(oError) {
				var value = $.parseJSON(oError.response.body).error.message.value;
				sap.m.MessageBox.show(
					value, {
						icon: sap.m.MessageBox.Icon.ERROR,
						title: "Error",
						styleClass: "sapUiSizeCompact messageBox"
					});
			}*/
		});

		/*var jModel = new sap.ui.model.json.JSONModel({
			isGSTActive: data.Active
		});
		this.setModel(jModel, "GSTModel");*/

		//End GST Code Changes

		this.getRouter().initialize();
	},

	exit: function() {
		this._routeMatchedHandler.destroy();
	},
	setRouterSetCloseDialogs: function(bCloseDialogs) {
		this._bRouterCloseDialogs = bCloseDialogs;
		if (this._routeMatchedHandler) {
			this._routeMatchedHandler.setCloseDialogs(bCloseDialogs);
		}
	},

	_initODataModel: function(sServiceUrl) {
		var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl, true);
		oModel.attachRequestFailed(null, "");
		oModel.setDefaultCountMode("None");
		this.setModel(oModel);
	}
});