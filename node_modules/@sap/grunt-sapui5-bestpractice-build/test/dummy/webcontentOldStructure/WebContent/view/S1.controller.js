jQuery.sap.require("sap.m.MessageBox");
jQuery.sap.require("sap.m.MessageToast");

sap.ui.controller("com.ril.IntMovMatPos.view.S1", {

	onInit: function() {
		that = this;
		oCore = sap.ui.getCore();
		oView = that.getView();
		 that.oModelMaterial = new sap.ui.model.odata.ODataModel(com.ril.IntMovMatPos.util.Formatter.getServiceUrlMaterial(),true);
		 that.oModelWarehouse = new sap.ui.model.odata.ODataModel(com.ril.IntMovMatPos.util.Formatter.getServiceUrlWarehouse(),true);
			
		ga('send', 'pageview', 'SW__MatDwn/S1');
		busyDialog = new sap.m.BusyDialog();
		that.TableBinding();
	},

	//Table Binding
	TableBinding: function() {
		that.oTable = oView.byId("TableId");
		 var filters = new Array();  
		filters.push(new sap.ui.model.Filter("WHCode", sap.ui.model.FilterOperator.EQ,"BWW1"));
		 that.oModelMaterial.read("/ExciseInvoiceDtlSet", {
			filters: filters,
			async: false,
			success: function(oData, ores) {
				var oJson = new sap.ui.model.json.JSONModel(oData);
				oView.byId("TableId").setModel(oJson);
			},
			error: function(oError) {
				var x = $.parseJSON(oError.response.body);
				var value = x.error.message.value;
				busyDialog.close();
				sap.m.MessageBox.show(
					value, {
						icon: sap.m.MessageBox.Icon.ERROR,
						title: "Error",
						styleClass: "sapUiSizeCompact messageBox",
					});
			}
		});
	},
	
	//Excise Invoice No. Fragment Close Method.  
	FragClose: function() {
		that.ExciseFrag.close();
		that.ExciseFrag.destroy();
		that.ExciseFrag = undefined;
		if (oCore.byId("FragCloseId") != undefined) {
			oCore.byId("FragCloseId").destroy();
		}
		if (oCore.byId("TableId1") != undefined) {
			oCore.byId("TableId1").destroy();
		}
		if (oCore.byId("TableTemplate1") != undefined) {
			oCore.byId("TableTemplate1").destroy();
		}
		if (oCore.byId("button1") != undefined) {
			oCore.byId("button1").destroy();
		}
		if (oCore.byId("button2") != undefined) {
			oCore.byId("button2").destroy();
		}
	},
	
	//On Exit.
	onExit: function() {
	//	that.onReset();
	},

	onDisplayPress:function(oEvent){
		that.ExciseFrag = sap.ui.xmlfragment("com.ril.IntMovMatPos.view.ExciseFrag", that);
		that.oTable = oCore.byId("TableId1");
		
		that.oModelWarehouse.read("/WarehouseSet", {
		//	filters: fil,
			success: function(oData, ores) {
				var oJson = new sap.ui.model.json.JSONModel(oData);
				oCore.byId("TableId1").setModel(oJson);
			},
			error: function(oError) {
				var x = $.parseJSON(oError.response.body);
				var value = x.error.message.value;
				busyDialog.close();
				sap.m.MessageBox.show(
					value, {
						icon: sap.m.MessageBox.Icon.ERROR,
						title: "Error",
						styleClass: "sapUiSizeCompact messageBox",
					});
			}
		});
		that.ExciseFrag.attachBrowserEvent("keydown",function(oEvent) {
			if (oEvent.keyCode === 27) {
				oEvent.stopPropagation();
				oEvent.preventDefault();
			}
		});
		that.ExciseFrag.open();
	},
	/*onPrintPress:function(oEvent){
	  	var oTable = oCore.byId("TableId1");
		len = oTable.getItems().length;
		var count ="0";
		for (var i = 0; i < len; i++) {
			var Item = oTable.mAggregations.items[i].mAggregations.cells[0];
			var evt =  oEvent.oSource.oParent.oParent.mAggregations.cells[0];
			if (Item.mProperties.text == evt.mProperties.text) {
				Item.removeAllCustomData();
				Item.addCustomData(new sap.ui.core.CustomData({
					value: "Yes",
				}));
			}
			cd = oTable.getItems()[i].mAggregations.cells[0].mAggregations.customData[0];
			if(cd)
			   count ++;
		
     	}
		if(len ==count){
			oCore.byId("FragCloseId").setEnabled(true);
		}
	},*/
	onPrintPress :function(oEvent){
		var oTable = oCore.byId("TableId1"), len = oTable.getItems().length,cd=0;
		for(var i = 0; i < len; i++) {
			var Item = oTable.mAggregations.items[i].mAggregations.cells[0];
			var evt =  oEvent.oSource.oParent.oParent.mAggregations.cells[0];
			if(Item.mProperties.text == evt.mProperties.text){
				if(oEvent.oSource.sId.substring(0,7) == "button1"){
					oEvent.oSource.oParent.mAggregations.items[0].removeAllCustomData();
					oEvent.oSource.oParent.mAggregations.items[0].addCustomData(
						new sap.ui.core.CustomData({
							value: "Yes",
						}));
				 }
				else{
					oEvent.oSource.oParent.mAggregations.items[1].removeAllCustomData();
					oEvent.oSource.oParent.mAggregations.items[1].addCustomData(
						new sap.ui.core.CustomData({
							value: "Yes",
					}));
				}
			}
		}
		for(var i=0;i<len;i++){
			for(var j=0;j<2;j++){
				if(oTable.getItems()[i].mAggregations.cells[2].getItems()[j].mAggregations.customData[0])
					  cd ++;
				}
		}
		if((len*2) == cd){
			oCore.byId("FragCloseId").setEnabled(true);
		}
	},
	
});